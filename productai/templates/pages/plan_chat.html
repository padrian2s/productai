{% extends "base.html" %}
{% block title %}Plan Mode — {{ plan.title }} — ProductAI{% endblock %}

{% block content %}
<div class="flex flex-col h-full">
    <!-- Header -->
    <div class="border-b border-gray-200 bg-white px-6 py-4 flex items-center justify-between shrink-0">
        <div>
            <div class="text-sm text-gray-500">
                <a href="/" class="hover:text-brand-600">Dashboard</a>
                <span class="mx-1">/</span>
                <a href="/plans/{{ plan.id }}" class="hover:text-brand-600">{{ plan.title }}</a>
                <span class="mx-1">/</span>
                <span class="text-gray-900">Plan Mode</span>
            </div>
            <h1 class="text-lg font-semibold mt-1 flex items-center gap-2">
                <span class="inline-flex w-2 h-2 rounded-full bg-emerald-500 animate-pulse"></span>
                AI Plan Mode
            </h1>
        </div>
        <a href="/plans/{{ plan.id }}" class="text-sm text-gray-500 hover:text-gray-700">Back to Plan</a>
    </div>

    <!-- Chat messages -->
    <div id="chat-messages" class="flex-1 overflow-y-auto p-6 space-y-4">
        <!-- System welcome -->
        <div class="chat-bubble flex gap-3 max-w-3xl mx-auto">
            <div class="w-8 h-8 rounded-full bg-brand-100 text-brand-600 flex items-center justify-center shrink-0 text-sm font-bold">AI</div>
            <div class="bg-white border border-gray-200 rounded-2xl rounded-tl-sm px-4 py-3 prose text-sm">
                <p>Welcome to <strong>Plan Mode</strong> for "{{ plan.title }}"! I'll help you develop a comprehensive product strategy.</p>
                <p>Let's start — what problem is this product trying to solve, and who are the primary users?</p>
            </div>
        </div>

        {% set messages = session.messages | default('[]') %}
        {% for msg in messages | tojson | from_json if messages != '[]' %}
        {% endfor %}
    </div>

    <!-- Typing indicator (hidden by default) -->
    <div id="typing-indicator" class="hidden px-6 pb-2 max-w-3xl mx-auto w-full">
        <div class="flex gap-3">
            <div class="w-8 h-8 rounded-full bg-brand-100 text-brand-600 flex items-center justify-center shrink-0 text-sm font-bold">AI</div>
            <div class="bg-white border border-gray-200 rounded-2xl rounded-tl-sm px-4 py-3">
                <div class="flex gap-1">
                    <span class="typing-dot w-2 h-2 bg-gray-400 rounded-full"></span>
                    <span class="typing-dot w-2 h-2 bg-gray-400 rounded-full"></span>
                    <span class="typing-dot w-2 h-2 bg-gray-400 rounded-full"></span>
                </div>
            </div>
        </div>
    </div>

    <!-- Input area -->
    <div class="border-t border-gray-200 bg-white p-4 shrink-0">
        <form id="chat-form" class="max-w-3xl mx-auto flex gap-3">
            <input type="text" id="chat-input" name="message" autocomplete="off"
                class="flex-1 px-4 py-3 rounded-xl border border-gray-300 focus:border-brand-500 focus:ring-2 focus:ring-brand-200 outline-none transition-all"
                placeholder="Describe your product vision, goals, audience...">
            <button type="submit" id="send-btn"
                class="px-5 py-3 bg-brand-600 text-white font-medium rounded-xl hover:bg-brand-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                Send
            </button>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
const chatMessages = document.getElementById('chat-messages');
const chatForm = document.getElementById('chat-form');
const chatInput = document.getElementById('chat-input');
const sendBtn = document.getElementById('send-btn');
const typingIndicator = document.getElementById('typing-indicator');

// Load existing messages
const existingMessages = JSON.parse('{{ session.messages | replace("'", "\\'") | safe }}' || '[]');
existingMessages.forEach(msg => addMessage(msg.role, msg.content));

function addMessage(role, content, isStreaming = false) {
    const div = document.createElement('div');
    div.className = 'chat-bubble flex gap-3 max-w-3xl mx-auto';

    if (role === 'user') {
        div.innerHTML = `
            <div class="ml-auto flex gap-3">
                <div class="bg-brand-600 text-white rounded-2xl rounded-tr-sm px-4 py-3 text-sm">
                    ${escapeHtml(content)}
                </div>
                <div class="w-8 h-8 rounded-full bg-gray-200 text-gray-600 flex items-center justify-center shrink-0 text-sm font-bold">U</div>
            </div>`;
    } else {
        const renderedContent = isStreaming ? content : renderMarkdown(content);
        div.innerHTML = `
            <div class="w-8 h-8 rounded-full bg-brand-100 text-brand-600 flex items-center justify-center shrink-0 text-sm font-bold">AI</div>
            <div class="bg-white border border-gray-200 rounded-2xl rounded-tl-sm px-4 py-3 prose text-sm ai-content">
                ${renderedContent}
            </div>`;
    }
    chatMessages.appendChild(div);
    chatMessages.scrollTop = chatMessages.scrollHeight;
    return div;
}

function escapeHtml(text) {
    const d = document.createElement('div');
    d.textContent = text;
    return d.innerHTML;
}

chatForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    const message = chatInput.value.trim();
    if (!message) return;

    chatInput.value = '';
    sendBtn.disabled = true;
    addMessage('user', message);

    typingIndicator.classList.remove('hidden');
    chatMessages.scrollTop = chatMessages.scrollHeight;

    const formData = new FormData();
    formData.append('message', message);

    let aiDiv = null;
    let fullText = '';

    streamAI('/api/ai/plan/{{ plan.id }}/chat', formData,
        (token) => {
            if (!aiDiv) {
                typingIndicator.classList.add('hidden');
                aiDiv = addMessage('assistant', '', true);
            }
            fullText += token;
            const contentEl = aiDiv.querySelector('.ai-content');
            contentEl.innerHTML = renderMarkdown(fullText);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        },
        () => {
            sendBtn.disabled = false;
            chatInput.focus();
            if (aiDiv) {
                const contentEl = aiDiv.querySelector('.ai-content');
                contentEl.innerHTML = renderMarkdown(fullText);
            }
        }
    );
});

chatInput.focus();
</script>
{% endblock %}
