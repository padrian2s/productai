{% extends "base.html" %}
{% block title %}{% if project %}Edit Project — {{ project.title }}{% else %}New Project{% endif %} — ProductAI{% endblock %}

{% macro enhance_icon(field_label) %}
<div class="enhance-popover">
    <button type="button" class="enhance-trigger" data-field="{{ field_label }}" title="Enhance with AI — hover to activate">
        <svg class="enhance-progress-ring" viewBox="0 0 36 36">
            <circle class="enhance-ring-bg" cx="18" cy="18" r="16"/>
            <circle class="enhance-ring-fill" cx="18" cy="18" r="16"
                transform="rotate(-90 18 18)"/>
        </svg>
        <svg class="enhance-bolt" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M13 10V3L4 14h7v7l9-11h-7z"/>
        </svg>
    </button>
</div>
{% endmacro %}

{% macro enhance_footer() %}
<div class="enhance-instruction">
    <div class="enhance-level-chips">
        <button type="button" data-level="light" title="Light: grammar &amp; clarity">L</button>
        <button type="button" data-level="medium" title="Medium: rewrite for impact" class="active">M</button>
        <button type="button" data-level="heavy" title="Heavy: expand &amp; enrich">H</button>
    </div>
    <input type="text" placeholder="Add instructions… Enter to enhance" autocomplete="off">
</div>
<span class="enhance-status"><span class="spinner"></span> Enhancing...</span>
<div class="enhance-preview"></div>
<div class="enhance-preview-actions">
    <button type="button" class="enhance-accept">Accept</button>
    <button type="button" class="enhance-discard">Discard</button>
</div>
{% endmacro %}

{% block content %}
<div class="p-8 max-w-3xl mx-auto">
    <nav class="text-sm text-gray-500 mb-6">
        <a href="/" class="hover:text-brand-600">Dashboard</a>
        <span class="mx-2">/</span>
        <span class="text-gray-900">{% if project %}Edit Project{% else %}New Project{% endif %}</span>
    </nav>

    <div class="flex items-center gap-3 mb-6">
        <h1 class="text-2xl font-bold">{% if project %}Edit Project{% else %}Create New Project{% endif %}</h1>
        {% if project and current_version is defined and current_version > 0 %}
        <a href="/projects/{{ project.id }}/versions" class="inline-flex items-center gap-1 px-2.5 py-1 text-xs font-semibold rounded-full bg-brand-50 text-brand-700 border border-brand-200 hover:bg-brand-100 transition-colors" title="View version history">
            <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                <path d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
            </svg>
            v{{ current_version }}
        </a>
        {% endif %}
    </div>

    <form action="{% if project %}/api/projects/{{ project.id }}{% else %}/api/projects{% endif %}" method="post" class="space-y-6" id="projectForm">
        <div class="enhance-wrap">
            <label for="title" class="block text-sm font-medium text-gray-700 mb-1">Project Title</label>
            <div class="enhance-field-row">
                {{ enhance_icon("Project Title") }}
                <input type="text" id="title" name="title" value="{{ project.title if project else '' }}" required
                    class="w-full px-4 py-2.5 rounded-lg border border-gray-300 focus:border-brand-500 focus:ring-2 focus:ring-brand-200 outline-none transition-all"
                    placeholder="e.g., Mobile Commerce Platform">
            </div>
            {{ enhance_footer() }}
        </div>

        <div class="enhance-wrap">
            <label for="description" class="block text-sm font-medium text-gray-700 mb-1">Description</label>
            <div class="enhance-field-row">
                {{ enhance_icon("Description") }}
                <textarea id="description" name="description" rows="3"
                    class="w-full px-4 py-2.5 rounded-lg border border-gray-300 focus:border-brand-500 focus:ring-2 focus:ring-brand-200 outline-none transition-all resize-none"
                    placeholder="Brief description of this project...">{{ project.description if project else '' }}</textarea>
            </div>
            {{ enhance_footer() }}
        </div>

        <div class="enhance-field-row">
            <div class="enhance-spacer"></div>
            <div class="flex-1 grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label for="status" class="block text-sm font-medium text-gray-700 mb-1">Status</label>
                    <select id="status" name="status"
                        class="w-full px-4 py-2.5 rounded-lg border border-gray-300 focus:border-brand-500 focus:ring-2 focus:ring-brand-200 outline-none">
                        {% set current_status = project.status if project else 'planning' %}
                        <option value="planning" {% if current_status == 'planning' %}selected{% endif %}>Planning</option>
                        <option value="active" {% if current_status == 'active' %}selected{% endif %}>Active</option>
                        <option value="on_hold" {% if current_status == 'on_hold' %}selected{% endif %}>On Hold</option>
                        <option value="completed" {% if current_status == 'completed' %}selected{% endif %}>Completed</option>
                        <option value="archived" {% if current_status == 'archived' %}selected{% endif %}>Archived</option>
                    </select>
                </div>
                <div>
                    <label for="priority" class="block text-sm font-medium text-gray-700 mb-1">Priority</label>
                    <select id="priority" name="priority"
                        class="w-full px-4 py-2.5 rounded-lg border border-gray-300 focus:border-brand-500 focus:ring-2 focus:ring-brand-200 outline-none">
                        {% set current_priority = project.priority if project else 'medium' %}
                        <option value="low" {% if current_priority == 'low' %}selected{% endif %}>Low</option>
                        <option value="medium" {% if current_priority == 'medium' %}selected{% endif %}>Medium</option>
                        <option value="high" {% if current_priority == 'high' %}selected{% endif %}>High</option>
                        <option value="critical" {% if current_priority == 'critical' %}selected{% endif %}>Critical</option>
                    </select>
                </div>
            </div>
        </div>

        <div class="enhance-wrap">
            <label for="lead" class="block text-sm font-medium text-gray-700 mb-1">Project Lead</label>
            <div class="enhance-field-row">
                {{ enhance_icon("Project Lead") }}
                <input type="text" id="lead" name="lead" value="{{ project.lead if project else '' }}"
                    class="w-full px-4 py-2.5 rounded-lg border border-gray-300 focus:border-brand-500 focus:ring-2 focus:ring-brand-200 outline-none transition-all"
                    placeholder="e.g., Jane Smith">
            </div>
            {{ enhance_footer() }}
        </div>

        <div class="enhance-field-row">
            <div class="enhance-spacer"></div>
            <div class="flex-1 grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label for="start_date" class="block text-sm font-medium text-gray-700 mb-1">Start Date</label>
                    <input type="date" id="start_date" name="start_date" value="{{ project.start_date if project else '' }}"
                        class="w-full px-4 py-2.5 rounded-lg border border-gray-300 focus:border-brand-500 focus:ring-2 focus:ring-brand-200 outline-none transition-all">
                </div>
                <div>
                    <label for="target_date" class="block text-sm font-medium text-gray-700 mb-1">Target Date</label>
                    <input type="date" id="target_date" name="target_date" value="{{ project.target_date if project else '' }}"
                        class="w-full px-4 py-2.5 rounded-lg border border-gray-300 focus:border-brand-500 focus:ring-2 focus:ring-brand-200 outline-none transition-all">
                </div>
            </div>
        </div>

        <!-- Members -->
        <div class="enhance-field-row">
            <div class="enhance-spacer"></div>
            <div class="flex-1">
                <label class="block text-sm font-medium text-gray-700 mb-2">Team Members</label>
                <div id="members-list" class="space-y-2">
                    <!-- Rows rendered by JS -->
                </div>
                <button type="button" id="add-member-btn"
                    class="mt-2 inline-flex items-center gap-1.5 px-3 py-1.5 text-sm font-medium text-brand-600 border border-brand-200 rounded-lg hover:bg-brand-50 transition-colors">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M12 5v14M5 12h14"/></svg>
                    Add Member
                </button>
                <input type="hidden" name="members" id="members-json" value="{{ project.members if project else '[]' }}">
            </div>
        </div>

        <!-- Milestones -->
        <div class="enhance-field-row">
            <div class="enhance-spacer"></div>
            <div class="flex-1">
                <label class="block text-sm font-medium text-gray-700 mb-2">Milestones</label>
                <div id="milestones-list" class="space-y-2">
                    <!-- Rows rendered by JS -->
                </div>
                <button type="button" id="add-milestone-btn"
                    class="mt-2 inline-flex items-center gap-1.5 px-3 py-1.5 text-sm font-medium text-brand-600 border border-brand-200 rounded-lg hover:bg-brand-50 transition-colors">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M12 5v14M5 12h14"/></svg>
                    Add Milestone
                </button>
                <input type="hidden" name="milestones" id="milestones-json" value="{{ project.milestones if project else '[]' }}">
            </div>
        </div>

        <div class="enhance-field-row pt-2">
            <div class="enhance-spacer"></div>
            <button type="submit" class="px-5 py-2.5 bg-brand-600 text-white font-medium rounded-lg hover:bg-brand-700 transition-colors">
                {% if project %}Save Changes{% else %}Create Project{% endif %}
            </button>
            <a href="{% if project %}/projects/{{ project.id }}{% else %}/{% endif %}" class="px-5 py-2.5 text-gray-600 font-medium rounded-lg hover:bg-gray-100 transition-colors">
                Cancel
            </a>
        </div>
    </form>
</div>
{% endblock %}

{% block scripts %}
<script>
(function() {
    const membersListEl = document.getElementById('members-list');
    const membersJsonEl = document.getElementById('members-json');
    const milestonesListEl = document.getElementById('milestones-list');
    const milestonesJsonEl = document.getElementById('milestones-json');

    let members = [];
    let milestones = [];

    try { members = JSON.parse(membersJsonEl.value); } catch(e) {}
    try { milestones = JSON.parse(milestonesJsonEl.value); } catch(e) {}

    function syncMembers() {
        membersJsonEl.value = JSON.stringify(members);
    }
    function syncMilestones() {
        milestonesJsonEl.value = JSON.stringify(milestones);
    }

    function renderMembers() {
        membersListEl.innerHTML = '';
        members.forEach((m, i) => {
            const row = document.createElement('div');
            row.className = 'flex items-center gap-2';
            row.innerHTML = `
                <input type="text" value="${esc(m.name)}" placeholder="Name" data-idx="${i}" data-field="name"
                    class="flex-1 px-3 py-2 rounded-lg border border-gray-300 text-sm focus:border-brand-500 focus:ring-2 focus:ring-brand-200 outline-none">
                <input type="text" value="${esc(m.role)}" placeholder="Role" data-idx="${i}" data-field="role"
                    class="flex-1 px-3 py-2 rounded-lg border border-gray-300 text-sm focus:border-brand-500 focus:ring-2 focus:ring-brand-200 outline-none">
                <button type="button" data-idx="${i}" class="remove-member p-1.5 text-gray-400 hover:text-red-500 transition-colors">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M6 18L18 6M6 6l12 12"/></svg>
                </button>`;
            membersListEl.appendChild(row);
        });
        // Bind events
        membersListEl.querySelectorAll('input').forEach(inp => {
            inp.addEventListener('input', () => {
                const idx = parseInt(inp.dataset.idx);
                members[idx][inp.dataset.field] = inp.value;
                syncMembers();
            });
        });
        membersListEl.querySelectorAll('.remove-member').forEach(btn => {
            btn.addEventListener('click', () => {
                members.splice(parseInt(btn.dataset.idx), 1);
                syncMembers();
                renderMembers();
            });
        });
    }

    function renderMilestones() {
        milestonesListEl.innerHTML = '';
        milestones.forEach((m, i) => {
            const row = document.createElement('div');
            row.className = 'flex items-center gap-2';
            row.innerHTML = `
                <input type="text" value="${esc(m.title)}" placeholder="Title" data-idx="${i}" data-field="title"
                    class="flex-1 px-3 py-2 rounded-lg border border-gray-300 text-sm focus:border-brand-500 focus:ring-2 focus:ring-brand-200 outline-none">
                <input type="date" value="${esc(m.date || '')}" data-idx="${i}" data-field="date"
                    class="px-3 py-2 rounded-lg border border-gray-300 text-sm focus:border-brand-500 focus:ring-2 focus:ring-brand-200 outline-none">
                <input type="text" value="${esc(m.description || '')}" placeholder="Description" data-idx="${i}" data-field="description"
                    class="flex-1 px-3 py-2 rounded-lg border border-gray-300 text-sm focus:border-brand-500 focus:ring-2 focus:ring-brand-200 outline-none">
                <select data-idx="${i}" data-field="status"
                    class="px-3 py-2 rounded-lg border border-gray-300 text-sm focus:border-brand-500 focus:ring-2 focus:ring-brand-200 outline-none">
                    <option value="pending" ${m.status === 'pending' ? 'selected' : ''}>Pending</option>
                    <option value="in_progress" ${m.status === 'in_progress' ? 'selected' : ''}>In Progress</option>
                    <option value="completed" ${m.status === 'completed' ? 'selected' : ''}>Completed</option>
                </select>
                <button type="button" data-idx="${i}" class="remove-milestone p-1.5 text-gray-400 hover:text-red-500 transition-colors">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M6 18L18 6M6 6l12 12"/></svg>
                </button>`;
            milestonesListEl.appendChild(row);
        });
        // Bind events
        milestonesListEl.querySelectorAll('input, select').forEach(inp => {
            inp.addEventListener('input', () => {
                const idx = parseInt(inp.dataset.idx);
                milestones[idx][inp.dataset.field] = inp.value;
                syncMilestones();
            });
            inp.addEventListener('change', () => {
                const idx = parseInt(inp.dataset.idx);
                milestones[idx][inp.dataset.field] = inp.value;
                syncMilestones();
            });
        });
        milestonesListEl.querySelectorAll('.remove-milestone').forEach(btn => {
            btn.addEventListener('click', () => {
                milestones.splice(parseInt(btn.dataset.idx), 1);
                syncMilestones();
                renderMilestones();
            });
        });
    }

    function esc(s) {
        return String(s || '').replace(/&/g,'&amp;').replace(/"/g,'&quot;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
    }

    document.getElementById('add-member-btn').addEventListener('click', () => {
        members.push({name: '', role: ''});
        syncMembers();
        renderMembers();
    });

    document.getElementById('add-milestone-btn').addEventListener('click', () => {
        milestones.push({title: '', date: '', status: 'pending', description: ''});
        syncMilestones();
        renderMilestones();
    });

    // Sync on submit
    document.getElementById('projectForm').addEventListener('submit', () => {
        syncMembers();
        syncMilestones();
    });

    // Initial render
    renderMembers();
    renderMilestones();
})();
</script>
{% endblock %}
