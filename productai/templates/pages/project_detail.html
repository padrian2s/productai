{% extends "base.html" %}
{% block title %}{{ project.title }} — ProductAI{% endblock %}

{% block content %}
<div class="p-8 max-w-4xl mx-auto">
    <nav class="text-sm text-gray-500 mb-6">
        <a href="{{ base_path }}/" class="hover:text-brand-600">Dashboard</a>
        <span class="mx-2">/</span>
        <span class="text-gray-900">{{ project.title }}</span>
    </nav>

    <!-- Project header -->
    <div class="bg-white rounded-xl border border-gray-200 p-6 mb-6">
        <div class="flex items-start justify-between">
            <div>
                <h1 class="text-2xl font-bold text-gray-900">{{ project.title }}</h1>
                {% if project.description %}
                <div class="prose text-gray-500 mt-2 md-render">{{ project.description }}</div>
                {% endif %}
            </div>
            <div class="flex items-center gap-2">
                {% if current_version > 0 %}
                <a href="{{ base_path }}/projects/{{ project.id }}/versions" class="inline-flex items-center gap-1.5 px-2.5 py-1 text-xs font-semibold rounded-full bg-brand-50 text-brand-700 border border-brand-200 hover:bg-brand-100 transition-colors" title="View version history">
                    <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                        <path d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                    v{{ current_version }}
                </a>
                {% endif %}
                <span class="inline-flex px-2 py-0.5 text-xs font-medium rounded-full
                    {% if project.priority == 'critical' %}bg-red-100 text-red-700
                    {% elif project.priority == 'high' %}bg-amber-100 text-amber-700
                    {% elif project.priority == 'medium' %}bg-blue-100 text-blue-700
                    {% else %}bg-gray-100 text-gray-600{% endif %}">
                    {{ project.priority }}
                </span>
                <span class="inline-flex px-3 py-1 text-sm font-medium rounded-full
                    {% if project.status == 'active' %}bg-emerald-100 text-emerald-700
                    {% elif project.status == 'completed' %}bg-blue-100 text-blue-700
                    {% elif project.status == 'on_hold' %}bg-orange-100 text-orange-700
                    {% elif project.status == 'archived' %}bg-gray-100 text-gray-500
                    {% else %}bg-amber-100 text-amber-700{% endif %}">
                    {{ project.status | replace('_', ' ') }}
                </span>
            </div>
        </div>

        <div class="flex gap-3 mt-5">
            <a href="{{ base_path }}/projects/{{ project.id }}/edit" class="inline-flex items-center gap-2 px-4 py-2 border border-gray-300 text-gray-700 text-sm font-medium rounded-lg hover:bg-gray-50 transition-colors">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                    <path d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                </svg>
                Edit
            </a>
            <a href="{{ base_path }}/projects/{{ project.id }}/versions" class="inline-flex items-center gap-2 px-4 py-2 border border-gray-300 text-gray-700 text-sm font-medium rounded-lg hover:bg-gray-50 transition-colors">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                    <path d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                </svg>
                History
            </a>
            <form action="{{ base_path }}/api/projects/{{ project.id }}/delete" method="post" onsubmit="return confirm('Delete this project? Plans will be unlinked but not deleted.')">
                <button type="submit" class="inline-flex items-center gap-2 px-4 py-2 border border-red-200 text-red-600 text-sm font-medium rounded-lg hover:bg-red-50 transition-colors">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                        <path d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                    </svg>
                    Delete
                </button>
            </form>
        </div>
    </div>

    <!-- Metadata grid -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
        {% if project.lead %}
        <div class="bg-white rounded-xl border border-gray-200 p-5">
            <h3 class="text-sm font-semibold text-gray-500 uppercase tracking-wider mb-2">Project Lead</h3>
            <p class="text-gray-700">{{ project.lead }}</p>
        </div>
        {% endif %}

        {% if project.start_date or project.target_date %}
        <div class="bg-white rounded-xl border border-gray-200 p-5">
            <h3 class="text-sm font-semibold text-gray-500 uppercase tracking-wider mb-2">Timeline</h3>
            <div class="flex items-center gap-3 text-gray-700">
                {% if project.start_date %}
                <span class="text-sm">{{ project.start_date }}</span>
                {% endif %}
                {% if project.start_date and project.target_date %}
                <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M5 12h14M12 5l7 7-7 7"/></svg>
                {% endif %}
                {% if project.target_date %}
                <span class="text-sm">{{ project.target_date }}</span>
                {% endif %}
            </div>
        </div>
        {% endif %}
    </div>

    <!-- Members list -->
    {% set members_data = project.members | default('[]', true) %}
    {% if members_data and members_data != '[]' %}
    <div class="bg-white rounded-xl border border-gray-200 p-6 mb-6">
        <h2 class="text-lg font-semibold mb-4">Team Members</h2>
        <div class="space-y-2">
            {% for member in members_data | tojson | default('[]', true) | safe %}{% endfor %}
        </div>
        <div id="members-display" class="space-y-2"></div>
    </div>
    {% endif %}

    <!-- Milestones -->
    {% set milestones_data = project.milestones | default('[]', true) %}
    {% if milestones_data and milestones_data != '[]' %}
    <div class="bg-white rounded-xl border border-gray-200 p-6 mb-6">
        <h2 class="text-lg font-semibold mb-4">Milestones</h2>

        <!-- Timeline Graph -->
        <div id="milestones-timeline" class="mb-6 overflow-x-auto"></div>

        <!-- Milestone List -->
        <div id="milestones-display" class="space-y-3"></div>
    </div>
    {% endif %}

    <!-- Linked Plans -->
    <div class="bg-white rounded-xl border border-gray-200 p-6 mb-6">
        <div class="flex items-center justify-between mb-4">
            <h2 class="text-lg font-semibold">Plans</h2>
            <a href="{{ base_path }}/plans/new" class="inline-flex items-center gap-1.5 px-3 py-1.5 bg-brand-600 text-white text-sm font-medium rounded-lg hover:bg-brand-700 transition-colors">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M12 5v14M5 12h14"/></svg>
                New Plan
            </a>
        </div>
        {% if plans %}
        <div class="space-y-3">
            {% for plan in plans %}
            <a href="{{ base_path }}/plans/{{ plan.id }}" class="block p-4 rounded-lg border border-gray-100 hover:border-brand-200 hover:bg-brand-50/30 transition-all">
                <div class="flex items-center justify-between">
                    <h3 class="font-medium">{{ plan.title }}</h3>
                    <span class="text-xs font-medium px-2 py-0.5 rounded-full
                        {% if plan.status == 'active' %}bg-emerald-100 text-emerald-700
                        {% elif plan.status == 'completed' %}bg-blue-100 text-blue-700
                        {% elif plan.status == 'archived' %}bg-gray-100 text-gray-500
                        {% else %}bg-amber-100 text-amber-700{% endif %}">
                        {{ plan.status }}
                    </span>
                </div>
                {% if plan.description %}
                <p class="text-sm text-gray-500 mt-1 line-clamp-2">{{ plan.description }}</p>
                {% endif %}
            </a>
            {% endfor %}
        </div>
        {% else %}
        <p class="text-gray-400 text-sm">No plans linked to this project yet.</p>
        {% endif %}
    </div>

    <!-- Linked PRDs (via Plans) -->
    {% if prds %}
    <div class="bg-white rounded-xl border border-gray-200 p-6">
        <h2 class="text-lg font-semibold mb-4">PRDs</h2>
        <div class="space-y-3">
            {% for prd in prds %}
            <a href="{{ base_path }}/prds/{{ prd.id }}" class="block p-4 rounded-lg border border-gray-100 hover:border-brand-200 hover:bg-brand-50/30 transition-all">
                <div class="flex items-center justify-between">
                    <h3 class="font-medium">{{ prd.title }}</h3>
                    <span class="text-xs font-medium px-2 py-0.5 rounded-full
                        {% if prd.status == 'review' %}bg-amber-100 text-amber-700
                        {% elif prd.status == 'approved' %}bg-emerald-100 text-emerald-700
                        {% else %}bg-blue-100 text-blue-700{% endif %}">
                        {{ prd.status }}
                    </span>
                </div>
            </a>
            {% endfor %}
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
<script>
(function() {
    // Render members from JSON
    const membersRaw = {{ project.members | default('[]', true) | tojson }};
    let members = [];
    try { members = JSON.parse(membersRaw); } catch(e) { members = membersRaw || []; }
    if (Array.isArray(members) && members.length > 0) {
        const container = document.getElementById('members-display');
        if (container) {
            members.forEach(m => {
                const div = document.createElement('div');
                div.className = 'flex items-center gap-3 py-2 px-3 rounded-lg bg-gray-50';
                div.innerHTML = `
                    <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                        <path d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                    </svg>
                    <span class="font-medium text-gray-900">${esc(m.name)}</span>
                    ${m.role ? '<span class="text-sm text-gray-500">' + esc(m.role) + '</span>' : ''}`;
                container.appendChild(div);
            });
        }
    }

    // Render milestones from JSON
    const milestonesRaw = {{ project.milestones | default('[]', true) | tojson }};
    let milestones = [];
    try { milestones = JSON.parse(milestonesRaw); } catch(e) { milestones = milestonesRaw || []; }
    if (Array.isArray(milestones) && milestones.length > 0) {
        // --- Timeline Graph ---
        const timelineContainer = document.getElementById('milestones-timeline');
        if (timelineContainer) {
            // Separate dated and undated milestones
            const dated = milestones
                .map((m, i) => ({ ...m, _idx: i }))
                .filter(m => m.date)
                .sort((a, b) => a.date.localeCompare(b.date));
            const undated = milestones.filter(m => !m.date);

            if (dated.length >= 2) {
                const parseDate = d => new Date(d + 'T00:00:00');
                const startDate = parseDate(dated[0].date);
                const endDate = parseDate(dated[dated.length - 1].date);
                const rangeMs = endDate - startDate || 1;

                // Today marker position
                const today = new Date();
                today.setHours(0,0,0,0);
                const todayPct = Math.max(0, Math.min(100, ((today - startDate) / rangeMs) * 100));
                const showToday = today >= startDate && today <= endDate;

                // Status colors for dots & connector
                const dotColors = {
                    'completed': { bg: '#059669', ring: '#d1fae5' },
                    'in_progress': { bg: '#d97706', ring: '#fef3c7' },
                    'pending': { bg: '#9ca3af', ring: '#f3f4f6' }
                };

                // Build the timeline SVG
                const nodeSpacing = 160;
                const svgWidth = Math.max(600, (dated.length - 1) * nodeSpacing + 120);
                const svgHeight = 120;
                const lineY = 50;
                const labelY = 88;

                // Calculate x positions for each node
                const nodePositions = dated.map(m => {
                    const pct = (parseDate(m.date) - startDate) / rangeMs;
                    return 60 + pct * (svgWidth - 120);
                });

                let svgParts = [];
                svgParts.push(`<svg width="${svgWidth}" height="${svgHeight}" viewBox="0 0 ${svgWidth} ${svgHeight}" class="block">`);

                // Background track line
                svgParts.push(`<line x1="${nodePositions[0]}" y1="${lineY}" x2="${nodePositions[nodePositions.length-1]}" y2="${lineY}" stroke="#e5e7eb" stroke-width="3" stroke-linecap="round"/>`);

                // Completed progress line
                const lastCompleted = [...dated].reverse().findIndex(m => m.status === 'completed');
                if (lastCompleted >= 0) {
                    const completedIdx = dated.length - 1 - lastCompleted;
                    svgParts.push(`<line x1="${nodePositions[0]}" y1="${lineY}" x2="${nodePositions[completedIdx]}" y2="${lineY}" stroke="#059669" stroke-width="3" stroke-linecap="round"/>`);
                }

                // Today marker
                if (showToday) {
                    const todayX = 60 + (todayPct / 100) * (svgWidth - 120);
                    svgParts.push(`<line x1="${todayX}" y1="${lineY - 18}" x2="${todayX}" y2="${lineY + 18}" stroke="#6366f1" stroke-width="2" stroke-dasharray="4 3" opacity="0.7"/>`);
                    svgParts.push(`<text x="${todayX}" y="${lineY - 22}" text-anchor="middle" fill="#6366f1" font-size="10" font-weight="600">Today</text>`);
                }

                // Nodes
                dated.forEach((m, i) => {
                    const x = nodePositions[i];
                    const col = dotColors[m.status] || dotColors['pending'];

                    // Outer ring
                    svgParts.push(`<circle cx="${x}" cy="${lineY}" r="12" fill="${col.ring}" />`);
                    // Inner dot
                    svgParts.push(`<circle cx="${x}" cy="${lineY}" r="7" fill="${col.bg}" />`);

                    // Checkmark for completed
                    if (m.status === 'completed') {
                        svgParts.push(`<path d="M${x-3} ${lineY} l2 3 l4 -5" fill="none" stroke="white" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>`);
                    }

                    // Title label (above line, alternating if crowded)
                    const titleEsc = esc(m.title.length > 20 ? m.title.slice(0, 18) + '...' : m.title);
                    svgParts.push(`<text x="${x}" y="${lineY - 20}" text-anchor="middle" fill="#111827" font-size="12" font-weight="500">${titleEsc}</text>`);

                    // Date label (below line)
                    const dateLabel = formatShortDate(m.date);
                    svgParts.push(`<text x="${x}" y="${labelY}" text-anchor="middle" fill="#9ca3af" font-size="11">${esc(dateLabel)}</text>`);
                });

                svgParts.push(`</svg>`);

                // Legend
                let legendHtml = `<div class="flex items-center gap-4 mt-3 text-xs text-gray-500">
                    <span class="flex items-center gap-1.5"><span class="inline-block w-2.5 h-2.5 rounded-full bg-emerald-600"></span> Completed</span>
                    <span class="flex items-center gap-1.5"><span class="inline-block w-2.5 h-2.5 rounded-full bg-amber-500"></span> In Progress</span>
                    <span class="flex items-center gap-1.5"><span class="inline-block w-2.5 h-2.5 rounded-full bg-gray-400"></span> Pending</span>
                    ${showToday ? '<span class="flex items-center gap-1.5"><span class="inline-block w-4 border-t-2 border-dashed border-indigo-500"></span> Today</span>' : ''}
                </div>`;

                // Undated milestones note
                let undatedNote = '';
                if (undated.length > 0) {
                    const names = undated.map(m => esc(m.title)).join(', ');
                    undatedNote = `<p class="text-xs text-gray-400 mt-2 italic">Not shown (no date): ${names}</p>`;
                }

                timelineContainer.innerHTML = `<div class="min-w-fit">${svgParts.join('')}</div>${legendHtml}${undatedNote}`;
            } else if (dated.length === 1) {
                // Single dated milestone — show a simple indicator
                const m = dated[0];
                const col = { 'completed': 'bg-emerald-600', 'in_progress': 'bg-amber-500', 'pending': 'bg-gray-400' }[m.status] || 'bg-gray-400';
                timelineContainer.innerHTML = `
                    <div class="flex items-center gap-3 py-3">
                        <div class="w-3 h-3 rounded-full ${col}"></div>
                        <span class="text-sm font-medium text-gray-700">${esc(m.title)}</span>
                        <span class="text-sm text-gray-400">${esc(formatShortDate(m.date))}</span>
                    </div>`;
            } else {
                // No dated milestones — hide the timeline
                timelineContainer.style.display = 'none';
            }
        }

        // --- Milestone list (existing) ---
        const container = document.getElementById('milestones-display');
        if (container) {
            milestones.forEach(m => {
                const statusColors = {
                    'pending': 'bg-gray-100 text-gray-600',
                    'in_progress': 'bg-amber-100 text-amber-700',
                    'completed': 'bg-emerald-100 text-emerald-700'
                };
                const colorClass = statusColors[m.status] || statusColors['pending'];
                const div = document.createElement('div');
                div.className = 'flex items-center gap-4 py-3 px-4 rounded-lg border border-gray-100';
                div.innerHTML = `
                    <div class="flex-1">
                        <div class="flex items-center gap-2">
                            <span class="font-medium text-gray-900">${esc(m.title)}</span>
                            <span class="inline-flex px-2 py-0.5 text-xs font-medium rounded-full ${colorClass}">${esc((m.status || 'pending').replace('_', ' '))}</span>
                        </div>
                        ${m.description ? '<p class="text-sm text-gray-500 mt-0.5">' + esc(m.description) + '</p>' : ''}
                    </div>
                    ${m.date ? '<span class="text-sm text-gray-400 whitespace-nowrap">' + esc(m.date) + '</span>' : ''}`;
                container.appendChild(div);
            });
        }
    }

    function esc(s) {
        const div = document.createElement('div');
        div.textContent = s || '';
        return div.innerHTML;
    }

    function formatShortDate(dateStr) {
        if (!dateStr) return '';
        const d = new Date(dateStr + 'T00:00:00');
        const months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
        return months[d.getMonth()] + ' ' + d.getDate() + ', ' + d.getFullYear();
    }
})();
</script>
{% endblock %}
